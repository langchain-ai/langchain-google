name: Auto Label Issues by Package

on:
  issues:
    types: [opened, edited]

jobs:
  label-by-package:
    permissions:
      issues: write
    runs-on: ubuntu-latest

    steps:
      - name: Extract package and apply label
        uses: actions/github-script@v6
        with:
          script: |
            const body = context.payload.issue.body || "";

            // Extract text under "### Package"
            const match = body.match(/### Package\s+([\s\S]*?)\n###/i);
            if (!match) return;

            const packageSection = match[1].trim();

            // Parse checkbox selections (look for "- [x] package-name" patterns)
            const checkboxMatches = packageSection.match(/- \[x\]\s+([^\n\r]+)/gi);
            if (!checkboxMatches) return;

            // Mapping table
            const mapping = {
              "langchain-google-genai": "genai",
              "langchain-google-vertexai": "vertexai",
              "langchain-google-community": "community",
            };

            // Extract package names and map to labels
            const labels = [];
            for (const match of checkboxMatches) {
              const packageName = match.replace(/- \[x\]\s+/i, '').trim();
              const label = mapping[packageName];
              if (label && !labels.includes(label)) {
                labels.push(label);
              }
            }

            // Add labels if any were found
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }
